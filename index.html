<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>东昌府区托育补贴综合管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); min-height: 100vh; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
        
        /* 头部样式 */
        header { background: linear-gradient(to right, #2c3e50, #4ca1af); color: white; padding: 20px; text-align: center; position: relative; }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .system-switcher { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); display: flex; gap: 10px; }
        .switch-btn { background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s; }
        .switch-btn:hover { background: rgba(255,255,255,0.3); }
        .switch-btn.active { background: white; color: #2c3e50; }
        
        /* 主内容区 */
        .main-content { display: flex; padding: 20px; gap: 20px; }
        .left-panel { flex: 1; min-width: 350px; }
        .right-panel { flex: 2; min-width: 500px; }
        
        .panel { background: #f9f9f9; border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid #e0e0e0; }
        
        .kindergarten-selector { margin-bottom: 20px; padding-bottom: 0px;}
        .kindergarten-selector select, 
        .kindergarten-selector input { width: 100%; padding: 12px; border: 2px solid #4ca1af; border-radius: 8px; font-size: 16px;}
        
        .upload-section { text-align: center; }
        .upload-area { padding: 30px; border: 3px dashed #4ca1af; border-radius: 10px; margin: 15px 0; background: #f0f9ff; cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { background: #e0f2ff; border-color: #2c3e50; }
        .upload-area.dragover { background: #d4edff; border-color: #1a2a6c; transform: scale(1.02); }
        .upload-icon { font-size: 40px; color: #4ca1af; margin-bottom: 10px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        
        .btn { background: #1a2a6c; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px; transition: all 0.3s; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ff9800; }
        .btn:disabled { background: #cccccc; cursor: not-allowed; }
        
        .preview-section { display: none; }
        .table-container { max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; font-size: 14px; }
        th { background: #4ca1af; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background: #f1f1f1; }
        
        tr.duplicate-row td {
            background: #ff4d4d !important;
            color: #fff !important;
            font-weight: bold;
        }

        .message { padding: 12px; border-radius: 6px; margin: 10px 0; display: none; }
        .success { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .warning { background: #ff9800; color: white; }
        
        .status-bar { background: #f8f9fa; padding: 12px; border-radius: 6px; margin: 15px 0; border-left: 4px solid #4ca1af; }
        .progress-bar { height: 10px; background: #e9ecef; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .progress { height: 100%; background: linear-gradient(to right, #4ca1af, #1a2a6c); width: 0%; transition: width 0.5s; }
        
        .file-info { background: #e9f7fe; padding: 12px; border-radius: 6px; margin: 10px 0; display: none; }
        
        /* 月度统计特有样式 */
        .date-selector { display: flex; gap: 8px; margin-bottom: 15px; align-items: center; }
        .date-selector .date-group { flex: 1; display: flex; align-items: center; background: white; border: 2px solid #4ca1af; border-radius: 8px; overflow: hidden; }
        .date-selector .date-label { padding: 0 12px; background: #4ca1af; color: white; font-weight: bold; min-width: 60px; text-align: center; }
        .date-selector select { flex: 1; padding: 10px; border: none; outline: none; background: white; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234ca1af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; padding-right: 35px; }
        /* 月度统计管理系统收窄 */
        #monthly-system .left-panel {
            flex: 0.5; /* 收窄1倍 */
            min-width: 250px;
            max-width: 350px;
        }
        /* 系统切换相关样式 */
        .system-content { display: none; }
        .system-content.active { display: block; }
        
        /* 单独添加人员表单样式 */
        .add-person-form { margin-top: 15px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row .form-group { flex: 1; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #4ca1af; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #1a2a6c; box-shadow: 0 0 5px rgba(26, 42, 108, 0.3); }
        
        /* 月份选择器面板样式 */
        .month-selector-panel {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        @media (max-width: 900px) {
            .main-content { flex-direction: column; }
            .system-switcher { position: static; justify-content: center; margin-bottom: 15px; }
            .form-row { flex-direction: column; gap: 15px; }
        }
        /* 人员管理系统收窄布局 */
        #person-system .left-panel {
            flex: 1;
            min-width: 0;
        }

        #person-system .left-panel > div {
            flex: 0.5; /* 收窄1倍 */
            min-width: 250px;
            max-width: 350px;
        }

        /* 响应式调整 */
        @media (max-width: 1100px) {
            #person-system .left-panel {
                flex-direction: column;
            }
            
            #person-system .left-panel > div {
                min-width: 100%;
                max-width: 100%;
            }
            
            #monthly-system .left-panel {
                min-width: 100%;
                max-width: 100%;
            }
        }
        /* 增加选择托育机构模块的间隔 */
        .kindergarten-selector {
            margin-bottom: 0px;    /* 底部外边距：5像素 */
            padding-top: 25px;     /* 上内边距：25像素 */
            padding-bottom: 0px;   /* 下内边距：5像素 */
            padding-left: 0;
            padding-right: 0;
        }

        .kindergarten-selector select {
            
            padding: 12px;
            border: 2px solid #4ca1af;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .kindergarten-selector input {
            margin-top: 10px;
            padding: 12px;
            border: 2px solid #4ca1af;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        /* 为选择框添加悬停效果 */
        .kindergarten-selector select:hover,
        .kindergarten-selector input:hover {
            border-color: #2c3e50;
        }

        .kindergarten-selector select:focus,
        .kindergarten-selector input:focus {
            outline: none;
            border-color: #1a2a6c;
            box-shadow: 0 0 5px rgba(26, 42, 108, 0.3);
        }
        /* 缩小选择托育机构的下边距 */
        .kindergarten-selector select {
            margin-bottom: 0px; /* 从15px减小到8px */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="system-switcher">
                <button class="switch-btn active" data-system="person">人员信息管理</button>
                <button class="switch-btn" data-system="monthly">月度统计管理</button>
            </div>
            <h1>东昌府区托育补贴综合管理系统</h1>
            <p id="system-subtitle">支持多个托育机构的数据管理</p>
        </header>

        <!-- 人员信息管理系统 -->
        <div class="system-content active" id="person-system">
            <div class="main-content">
                <div class="left-panel" style="display: flex; gap: 20px;">
                    <!-- 左侧：选择托育机构和导入模块 -->
                    <div style="flex: 0.5; min-width: 250px; max-width: 350px; display: flex; flex-direction: column; gap: 0px;">
                        <!-- 选择托育机构 -->
                        <div class="panel" style="flex: 1;">
                            <h2><i class="fas fa-school"></i> 选择托育机构</h2>
                            <div class="kindergarten-selector">
                                <select id="kindergarten-select">
                                    <option value="">-- 请选择托育机构 --</option>
                                    <option value="风貌街实验幼儿园">风貌街实验幼儿园</option>
                                    <option value="阳光幼儿园">阳光幼儿园</option>
                                    <option value="彩虹幼儿园">彩虹幼儿园</option>
                                    <option value="new">+ 新建托育机构</option>
                                </select>
                                <input type="text" id="new-kindergarten" placeholder="输入新机构名称" style="display:none;">
                            </div>
                        </div>
                        
                        <!-- 上传Excel文件 -->
                        <div class="panel" style="flex: 2;">
                            <h2><i class="fas fa-file-upload"></i> 上传Excel文件</h2>
                            <div class="upload-section">
                                <div class="upload-area" id="drop-area-person">
                                    <div class="upload-icon"><i class="fas fa-file-excel"></i></div>
                                    <p><strong>点击或拖放Excel文件到此处</strong></p>
                                    <p style="font-size: 12px; color: #666; margin-top: 10px;">支持 .xls 和 .xlsx 格式</p>
                                    <div class="file-input-wrapper">
                                        <button class="btn">选择Excel文件</button>
                                        <input type="file" id="file-input-person" accept=".xls,.xlsx">
                                    </div>
                                </div>
                                
                                <div class="file-info" id="file-info-person">
                                    <i class="fas fa-file-excel"></i>
                                    <span id="file-name-person">文件名.xlsx</span>
                                    <span id="file-size-person" style="font-size: 12px; color: #666;"></span>
                                </div>
                                
                                <button class="btn btn-success" id="import-btn-person" disabled onclick="importPersonData()">
                                    <i class="fas fa-database"></i> 导入数据
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧：单独添加人员模块 -->
                    <div class="panel" style="flex: 0.5; min-width: 250px; max-width: 350px;">
                        <h2><i class="fas fa-user-plus"></i> 单独添加人员</h2>
                        <div class="add-person-form">
                            <!-- 第一行：孩子姓名 + 胎次（并排） -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>孩子姓名</label>
                                    <input type="text" id="child-name" placeholder="请输入孩子姓名">
                                </div>
                                <div class="form-group">
                                    <label>孩次</label>
                                    <select id="birth-order">
                                        <option value="">请选择胎次</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- 第二行：孩子身份证号码（单独一行） -->
                            <div class="form-group">
                                <label>孩子身份证号码</label>
                                <input type="text" id="child-id" placeholder="请输入18位身份证号" maxlength="18">
                            </div>
                            
                            <!-- 第三行：父亲姓名 + 母亲姓名（并排） -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>父亲姓名</label>
                                    <input type="text" id="father-name" placeholder="请输入父亲姓名">
                                </div>
                                <div class="form-group">
                                    <label>母亲姓名</label>
                                    <input type="text" id="mother-name" placeholder="请输入母亲姓名">
                                </div>
                            </div>
                            
                            <!-- 第四行：父亲身份证号码（单独一行） -->
                            <div class="form-group">
                                <label>父亲身份证号码</label>
                                <input type="text" id="father-id" placeholder="请输入18位身份证号" maxlength="18">
                            </div>
                            
                            <!-- 第五行：母亲身份证号码（单独一行） -->
                            <div class="form-group">
                                <label>母亲身份证号码</label>
                                <input type="text" id="mother-id" placeholder="请输入18位身份证号" maxlength="18">
                            </div>
                            
                            <button class="btn btn-success" id="add-person-btn" onclick="addSinglePerson()" style="margin-top: 15px; width: 100%;">
                                <i class="fas fa-plus-circle"></i> 添加人员
                            </button>
                            
                            <div class="message success" id="add-success-message"></div>
                            <div class="message error" id="add-error-message"></div>
                        </div>
                    </div>
                </div>
        
              
                <div class="right-panel">
                    <div class="panel preview-section" id="preview-section-person">
                        <h2><i class="fas fa-table"></i> 数据预览 - <span id="preview-kindergarten-person"></span></h2>
                        
                        <div class="table-container">
                            <table id="preview-table-person">
                                <thead>
                                    <tr>
                                        <th>序号</th>
                                        <th>孩子姓名</th>
                                        <th>胎次</th>
                                        <th>孩子身份证</th>
                                        <th>父亲姓名</th>
                                        <th>母亲姓名</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-body-person"></tbody>
                            </table>
                        </div>
                        
                        <div class="status-bar" id="status-bar-person" style="display: none;">
                            <div id="status-text-person">正在处理数据...</div>
                            <div class="progress-bar">
                                <div class="progress" id="progress-bar-person"></div>
                            </div>
                        </div>
                        
                        <div class="message success" id="success-message-person"></div>
                        <div class="message error" id="error-message-person"></div>
                        <div class="message warning" id="warning-message-person"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 月度统计管理系统 -->
        <div class="system-content" id="monthly-system">
            <div class="main-content">
                <div class="left-panel">
                    <!-- 选择托育机构 -->
                    <div class="panel">
                        <h2><i class="fas fa-school"></i> 选择托育机构</h2>
                        <div class="kindergarten-selector">
                            <select id="kindergarten-select-monthly">
                                <option value="">-- 请选择托育机构 --</option>
                                <option value="风貌街实验幼儿园">风貌街实验幼儿园</option>
                                <option value="阳光幼儿园">阳光幼儿园</option>
                                <option value="彩虹幼儿园">彩虹幼儿园</option>
                            </select>
                        </div>
                    </div>

                    <!-- 选择统计月份 -->
                    <div class="month-selector-panel">
                        <h2><i class="fas fa-calendar-alt"></i> 选择统计月份</h2>
                        <div class="date-selector">
                            <div class="date-group">
                                <div class="date-label">年份</div>
                                <select id="year-select">
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025" selected>2025</option>
                                    <option value="2026">2026</option>
                                </select>
                            </div>
                            <div class="date-group">
                                <div class="date-label">月份</div>
                                <select id="month-select">
                                    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                    <option value="4" selected>4</option><option value="5">5</option><option value="6">6</option>
                                    <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                                    <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 上传Excel文件 -->
                    <div class="panel">
                        <h2><i class="fas fa-file-upload"></i> 上传Excel文件</h2>
                        <div class="upload-section">
                            <div class="upload-area" id="drop-area-monthly">
                                <div class="upload-icon"><i class="fas fa-file-excel"></i></div>
                                <p><strong>点击或拖放Excel文件到此处</strong></p>
                                <p style="font-size: 12px; color: #666;">支持 .xls 和 .xlsx 格式</p>
                                <div class="file-input-wrapper">
                                    <button class="btn">选择Excel文件</button>
                                    <input type="file" id="file-input-monthly" accept=".xls,.xlsx">
                                </div>
                            </div>
                            
                            <div class="file-info" id="file-info-monthly">
                                <i class="fas fa-file-excel"></i>
                                <span id="file-name-monthly">文件名.xlsx</span>
                            </div>
                            
                            <button class="btn btn-success" id="validate-btn-monthly" disabled onclick="validateMonthlyData()">
                                <i class="fas fa-check-circle"></i> 验证数据
                            </button>
                            <button class="btn" id="import-btn-monthly" disabled onclick="importMonthlyData()">
                                <i class="fas fa-database"></i> 导入数据
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="right-panel">
                    <div class="panel preview-section" id="preview-section-monthly">
                        <h2><i class="fas fa-table"></i> 数据预览与验证结果 - <span id="selected-date">2025年4月</span></h2>
                        
                        <div class="table-container">
                            <table id="preview-table-monthly">
                                <thead>
                                    <tr>
                                        <th>姓名</th>
                                        <th>胎次</th>
                                        <th>身份证号码</th>
                                        <th>家长姓名</th>
                                        <th>班级</th>
                                        <th>单月费用(元)</th>
                                        <th>出勤天数</th>
                                        <th>验证结果</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-body-monthly"></tbody>
                            </table>
                        </div>
                        
                        <div class="status-bar" id="status-bar-monthly" style="display: none;">
                            <div id="status-text-monthly">正在处理数据...</div>
                            <div class="progress-bar">
                                <div class="progress" id="progress-bar-monthly"></div>
                            </div>
                        </div>
                        
                        <div class="message success" id="success-message-monthly"></div>
                        <div class="message error" id="error-message-monthly"></div>
                        <div class="message warning" id="warning-message-monthly"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 系统切换功能
        document.querySelectorAll('.switch-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.switch-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const system = this.dataset.system;
                document.querySelectorAll('.system-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(system + '-system').classList.add('active');
                
                const subtitle = document.getElementById('system-subtitle');
                if (system === 'person') {
                    subtitle.textContent = '支持多个托育机构的数据管理';
                } else {
                    subtitle.textContent = '二孩、三孩入托月度统计表验证与导入';
                }
            });
        });

        // 人员信息管理系统的变量和函数
        let personExcelData = [];
        let selectedKindergarten = '';
        let duplicateIds = new Set();
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            initPersonDragAndDrop();
            setupPersonEventListeners();
        });
        
        function setupPersonEventListeners() {
            // 幼儿园选择逻辑
            document.getElementById('kindergarten-select').addEventListener('change', function(e) {
                if (e.target.value === 'new') {
                    document.getElementById('new-kindergarten').style.display = 'block';
                    selectedKindergarten = '';
                } else {
                    document.getElementById('new-kindergarten').style.display = 'none';
                    selectedKindergarten = e.target.value;
                }
                updatePersonImportButton();
            });
            
            document.getElementById('new-kindergarten').addEventListener('input', function(e) {
                selectedKindergarten = e.target.value;
                updatePersonImportButton();
            });
            
            // 文件选择逻辑
            document.getElementById('file-input-person').addEventListener('change', function(e) {
                handlePersonFileSelect(e.target.files);
            });
        }
        
        function initPersonDragAndDrop() {
            const dropArea = document.getElementById('drop-area-person');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            dropArea.addEventListener('drop', handlePersonDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                dropArea.classList.add('dragover');
            }
            
            function unhighlight() {
                dropArea.classList.remove('dragover');
            }
            
            function handlePersonDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handlePersonFileSelect(files);
            }
        }
        
        function handlePersonFileSelect(files) {
            if (!selectedKindergarten) {
                showPersonMessage('error-message-person', '请先选择或输入幼儿园名称');
                return;
            }
            
            if (files.length === 0) return;
            
            const file = files[0];
            if (!file.name.match(/\.(xls|xlsx)$/i)) {
                showPersonMessage('error-message-person', '请选择Excel文件（.xls 或 .xlsx）');
                return;
            }
            
            document.getElementById('file-info-person').style.display = 'block';
            document.getElementById('file-name-person').textContent = file.name;
            document.getElementById('file-size-person').textContent = formatFileSize(file.size);
            
            showPersonStatus('正在读取Excel文件...', 30);
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    processPersonExcelData(jsonData);
                    showPersonStatus('文件读取完成', 100);
                    setTimeout(() => hidePersonStatus(), 1000);
                    
                } catch (error) {
                    hidePersonStatus();
                    showPersonMessage('error-message-person', '文件读取失败: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                hidePersonStatus();
                showPersonMessage('error-message-person', '文件读取错误');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function processPersonExcelData(data) {
            personExcelData = [];
            duplicateIds.clear();
            
            for (let i = 2; i < data.length; i++) {
                const row = data[i];
                if (row && row.length >= 8 && row[1]) {
                    const person = {
                        serialNumber: row[0] || '',
                        childName: row[1] || '',
                        birthOrder: row[2] || '',
                        childId: String(row[3] || '').trim(),
                        fatherName: row[4] || '',
                        fatherId: String(row[5] || '').trim(),
                        motherName: row[6] || '',
                        motherId: String(row[7] || '').trim(),
                        isDuplicate: false,
                        isDbDuplicate: false
                    };
                    
                    personExcelData.push(person);
                }
            }
            
            checkPersonDuplicates();
            renderPersonPreview();
            document.getElementById('preview-section-person').style.display = 'block';
            document.getElementById('preview-kindergarten-person').textContent = selectedKindergarten;
            updatePersonImportButton();
        }
        
        function checkPersonDuplicates() {
            const idMap = {};
            
            personExcelData.forEach(person => {
                if (person.childId) {
                    idMap[person.childId] = (idMap[person.childId] || 0) + 1;
                }
            });
            
            personExcelData.forEach(person => {
                if (person.childId && idMap[person.childId] > 1) {
                    person.isDuplicate = true;
                    duplicateIds.add(person.childId);
                }
            });
        }
        
        function renderPersonPreview() {
            const tbody = document.getElementById('preview-body-person');
            tbody.innerHTML = '';

            personExcelData.forEach((person, index) => {
                const row = document.createElement('tr');

                if (person.isDuplicate || person.isDbDuplicate) {
                    row.classList.add('duplicate-row');
                }

                row.innerHTML = `
                    <td>${person.serialNumber}</td>
                    <td>${person.childName}</td>
                    <td>${person.birthOrder}</td>
                    <td>${formatIdNumber(person.childId)}</td>
                    <td>${person.fatherName}</td>
                    <td>${person.motherName}</td>
                    <td>
                        ${person.isDuplicate ? '<span style="color:red">Excel重复</span>' : 
                        person.isDbDuplicate ? '<span style="color:red">数据库重复</span>' : '正常'}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            if (duplicateIds.size > 0) {
                showPersonMessage('warning-message-person', `检测到 ${duplicateIds.size} 个重复的身份证号（红色标记）`);
            }
        }
        
        function importPersonData() {
            if (personExcelData.length === 0) {
                showPersonMessage('error-message-person', '没有数据可导入');
                return;
            }
            
            const dataToSend = {
                kindergarten: selectedKindergarten,
                persons: personExcelData
            };
            
            showPersonStatus('正在导入数据...', 30);
            document.getElementById('import-btn-person').disabled = true;
            
            setTimeout(() => {
                const hasDuplicates = duplicateIds.size > 0;
                
                if (hasDuplicates) {
                    personExcelData.forEach(person => {
                        if (person.isDuplicate) person.isDbDuplicate = true;
                    });
                    renderPersonPreview();
                    updatePersonImportButton();
                    showPersonMessage('warning-message-person', `检测到重复数据，不允许导入`);
                } else {
                    showPersonStatus('导入成功', 100);
                    showPersonMessage('success-message-person', '数据导入成功！');
                }
                
                setTimeout(() => {
                    hidePersonStatus();
                    document.getElementById('import-btn-person').disabled = false;
                }, 2000);
                
            }, 1500);
        }
        
        function updatePersonImportButton() {
            const importBtn = document.getElementById('import-btn-person');
            importBtn.disabled = !selectedKindergarten || personExcelData.length === 0 || duplicateIds.size > 0;
        }

        // 单独添加人员功能
        function addSinglePerson() {
            const childName = document.getElementById('child-name').value.trim();
            const birthOrder = document.getElementById('birth-order').value;
            const childId = document.getElementById('child-id').value.trim();
            const fatherName = document.getElementById('father-name').value.trim();
            const fatherId = document.getElementById('father-id').value.trim();
            const motherName = document.getElementById('mother-name').value.trim();
            const motherId = document.getElementById('mother-id').value.trim();
            
            if (!childName) {
                showAddMessage('add-error-message', '请输入孩子姓名');
                return;
            }
            
            if (!birthOrder) {
                showAddMessage('add-error-message', '请选择胎次');
                return;
            }
            
            if (!childId || childId.length !== 18) {
                showAddMessage('add-error-message', '请输入有效的18位身份证号');
                return;
            }
            
            if (!selectedKindergarten) {
                showAddMessage('add-error-message', '请先选择托育机构');
                return;
            }
            
            const isDuplicate = personExcelData.some(person => person.childId === childId);
            if (isDuplicate) {
                showAddMessage('add-error-message', '该身份证号已存在，不能重复添加');
                return;
            }
            
            const newPerson = {
                serialNumber: personExcelData.length + 1,
                childName: childName,
                birthOrder: birthOrder,
                childId: childId,
                fatherName: fatherName,
                fatherId: fatherId,
                motherName: motherName,
                motherId: motherId,
                isDuplicate: false,
                isDbDuplicate: false
            };
            
            personExcelData.push(newPerson);
            renderPersonPreview();
            
            document.getElementById('child-name').value = '';
            document.getElementById('birth-order').value = '';
            document.getElementById('child-id').value = '';
            document.getElementById('father-name').value = '';
            document.getElementById('father-id').value = '';
            document.getElementById('mother-name').value = '';
            document.getElementById('mother-id').value = '';
            
            showAddMessage('add-success-message', '人员添加成功！');
            updatePersonImportButton();
        }

        // 辅助函数
        function formatIdNumber(id) {
            if (!id) return '';
            if (id.length !== 18) return id;
            return id.substring(0, 6) + '****' + id.substring(14);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showPersonStatus(text, progress) {
            const statusBar = document.getElementById('status-bar-person');
            const statusText = document.getElementById('status-text-person');
            const progressBar = document.getElementById('progress-bar-person');
            
            statusBar.style.display = 'block';
            statusText.textContent = text;
            progressBar.style.width = progress + '%';
        }
        
        function hidePersonStatus() {
            document.getElementById('status-bar-person').style.display = 'none';
        }
        
        function showPersonMessage(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 5000);
        }
        
        function showAddMessage(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 3000);
        }

        // 月度统计相关函数（保持不变）
        // ... 原有的月度统计JavaScript代码 ...
    </script>
</body>
</html>